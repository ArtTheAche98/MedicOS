{% extends 'core/base.html' %}

{% block title %}Dashboard - MedicOS{% endblock %}

{% block extra_css %}
    <link href="https://unpkg.com/@fullcalendar/core@4.4.0/main.min.css" rel="stylesheet"/>
    <link href="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
    {% csrf_token %}
    <div class="space-y-6">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">Welcome, {{ user.get_full_name|default:user.username }}</h1>
            <button onclick="document.getElementById('addMedicationModal').classList.remove('hidden')"
                    class="btn-primary text-white px-4 py-2 rounded-md">
                Add Medication
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Active Medications -->
            <div class="medical-card p-6 col-span-2">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Active Medications</h2>
                <div id="medicationsContainer" class="space-y-4">
                    {% if medications %}
                        {% for medication in medications %}
                            <div id="medication-{{ medication.id }}"
                                 class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <h3 class="font-medium text-gray-900">{{ medication.name }}</h3>
                                    <p class="text-sm text-gray-600">{{ medication.dosage }}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showMedicationDetails('{{ medication.id }}')"
                                            class="text-blue-600 hover:text-blue-800">
                                        Details
                                    </button>
                                    <button onclick="removeMedication('{{ medication.id }}')"
                                            class="text-red-600 hover:text-red-800">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p id="noMedicationsMessage" class="text-gray-600">No active medications</p>
                    {% endif %}
                </div>
            </div>

            <!-- Upcoming Reminders -->
            <div class="medical-card p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Upcoming Reminders</h2>
                <div id="calendar"></div>
            </div>
        </div>

        <!-- Recent Interactions -->
        <div class="medical-card p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Drug Interactions</h2>
            <div id="interactionsContainer">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Medication Modal -->
    <div id="addMedicationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Add New Medication</h3>
                <form id="addMedicationForm" class="mt-4 space-y-4">
                    {% csrf_token %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Medication Name</label>
                        <input type="text" name="name" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Dosage</label>
                        <input type="text" name="dosage" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Schedule Time</label>
                        <select name="time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="08:00">Morning (8:00 AM)</option>
                            <option value="12:00">Noon (12:00 PM)</option>
                            <option value="18:00">Evening (6:00 PM)</option>
                            <option value="22:00">Night (10:00 PM)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" name="startDate" required
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" name="endDate"
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <p class="mt-1 text-sm text-gray-500">Leave empty for indefinite duration</p>
                    </div>
                    <div class="flex justify-end space-x-3 mt-5">
                        <button type="button"
                                onclick="document.getElementById('addMedicationModal').classList.add('hidden')"
                                class="btn-secondary text-white px-4 py-2 rounded-md">
                            Cancel
                        </button>
                        <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md">
                            Add Medication
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Medication Details Modal -->
    <div id="medicationDetailsModal"
         class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900">Medication Details</h3>
                <div id="medicationDetailsContent" class="mt-4 space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="flex justify-end mt-5">
                    <button onclick="document.getElementById('medicationDetailsModal').classList.add('hidden')"
                            class="btn-secondary text-white px-4 py-2 rounded-md">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/@fullcalendar/core@4.4.0/main.min.js"></script>
    <script src="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Initialize calendar
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                try {
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        plugins: ['dayGrid'],
                        defaultView: 'dayGridWeek',
                        events: '/api/medications/schedule/',
                        validRange: {
                            start: new Date()
                        },
                        eventRender: function (info) {
                            info.el.title = info.event.title;
                        }
                    });
                    calendar.render();
                } catch (error) {
                    console.error('Error initializing calendar:', error);
                    calendarEl.innerHTML = '<p class="text-red-600">Error loading calendar. Please refresh the page.</p>';
                }
            }

            // Form handling
            const addMedicationForm = document.getElementById('addMedicationForm');
            if (addMedicationForm) {
                addMedicationForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const submitButton = this.querySelector('button[type="submit"]');
                    if (!submitButton) return;

                    submitButton.disabled = true;

                    const medicationData = {
                        name: formData.get('name'),
                        dosage: formData.get('dosage'),
                        schedule: {
                            time: formData.get('time'),
                            startDate: formData.get('startDate'),
                            endDate: formData.get('endDate') || null,
                            days: [0, 1, 2, 3, 4, 5, 6]
                        }
                    };

                    const medicationsContainer = document.getElementById('medicationsContainer');
                    if (!medicationsContainer) {
                        console.error('Medications container not found');
                        submitButton.disabled = false;
                        alert('Error: Could not find medications container. Please refresh the page.');
                        return;
                    }

                    const noMedsMessage = medicationsContainer.querySelector('#noMedicationsMessage');
                    if (noMedsMessage) {
                        noMedsMessage.remove();
                    }

                    const tempId = 'temp-' + Date.now();
                    const newMedElement = createMedicationElement({
                        ...medicationData,
                        id: tempId
                    });

                    medicationsContainer.insertAdjacentHTML('afterbegin', newMedElement);

                    // Close modal and reset form
                    document.getElementById('addMedicationModal').classList.add('hidden');
                    addMedicationForm.reset();

                    // Send request to server
                    fetch('/api/medications/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify(medicationData)
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            if (data.medication) {
                                const tempElement = document.getElementById(`medication-${tempId}`);
                                if (tempElement) {
                                    tempElement.id = `medication-${data.medication.id}`;
                                }
                                if (calendar) calendar.refetchEvents();
                                setTimeout(fetchAndUpdateInteractions, 1000);
                            } else {
                                throw new Error('Invalid server response');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            const tempElement = document.getElementById(`medication-${tempId}`);
                            if (tempElement) tempElement.remove();
                            alert('Error adding medication. Please try again.');
                        })
                        .finally(() => {
                            submitButton.disabled = false;
                        });
                });
            }
        })
    </script>

    <script>
document.addEventListener('DOMContentLoaded',function (){

            // Loading initial interactions
            fetchAndUpdateInteractions();

            // Make functions globally available
            window.removeMedication = removeMedication;
            window.showMedicationDetails = showMedicationDetails;
            window.toggleDescription = toggleDescription;
        });

        function removeMedication(medicationId) {
            if (!medicationId || !confirm('Are you sure you want to remove this medication?')) {
                return;
            }

            fetch(`/api/medications/${medicationId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error removing medication:', error);
                    alert('Error removing medication: ' + error.message);
                });
        }

        // Helper functions
        function createMedicationElement(medication) {
            return `
        <div id="medication-${medication.id}" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
                <h3 class="font-medium text-gray-900">${medication.name}</h3>
                <p class="text-sm text-gray-600">${medication.dosage}</p>
                ${medication.schedule ? `
                    <p class="text-xs text-gray-500">
                        ${formatSchedule(medication.schedule)}
                    </p>
                ` : ''}
            </div>
            <div class="flex space-x-2">
                <button onclick="showMedicationDetails('${medication.id}')"
                        class="text-blue-600 hover:text-blue-800">
                    Details
                </button>
                <button onclick="removeMedication('${medication.id}')"
                        class="text-red-600 hover:text-red-800">
                    Remove
                </button>
            </div>
        </div>
    `;
        }

        function formatSchedule(schedule) {
            if (!schedule || !schedule.time) return 'Schedule not specified';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const scheduleDays = schedule.days.map(d => days[d]).join(', ');
            return `${schedule.time} on ${scheduleDays}`;
        }

        function formatDate(dateString) {
            if (!dateString || dateString === 'Not specified' || dateString === 'Ongoing') {
                return dateString;
            }
            return new Date(dateString).toLocaleDateString();
        }

function updateInteractionsDisplay(interactions) {
    const container = document.getElementById('interactionsContainer');
        if (!interactions.length) {
            container.innerHTML = '<p class="text-gray-600">No interactions found</p>';
            return;
        }

        interactions.sort((a, b) => b.severity - a.severity);

        container.innerHTML = interactions.map(interaction => {
            let severityClass, severityText;

            switch(interaction.severity) {
                case 3:
                    severityClass = 'red';
                    severityText = 'High Risk';
                    break;
                case 2:
                    severityClass = 'yellow';
                    severityText = 'Use with Caution';
                    break;
                default:
                    severityClass = 'blue';
                    severityText = 'Low Risk';
            }

            return `
                <div class="p-4 bg-${severityClass}-50 rounded-lg mb-3">
                    <div class="flex justify-between items-start">
                        <h4 class="font-medium">${interaction.drugs.join(' + ')}</h4>
                        <span class="text-sm text-${severityClass}-700 bg-${severityClass}-100 px-2 py-1 rounded">
                            ${severityText}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">${interaction.description}</p>
                    ${interaction.source === 'Fallback' ?
                        `<p class="text-xs text-gray-500 mt-2 italic">
                            Unable to fetch detailed data. Please consult healthcare provider.
                        </p>` : ''}
                </div>
            `;
        }).join('');

}

function fetchAndUpdateInteractions() {
            const container = document.getElementById('interactionsContainer');
            if (!container) return;

            container.innerHTML = `
        <div class="p-4 bg-gray-50 rounded-lg mb-3">
            <div class="flex items-center space-x-3">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm text-gray-600">Checking drug interactions...</span>
            </div>
        </div>
    `;

            fetch('/api/medications/interactions/')
                .then(response => response.json())
                .then(data => {
                    if (data.interactions) {
                        updateInteractionsDisplay(data.interactions);
                    } else {
                        container.innerHTML = '<p class="text-gray-600">No interactions found</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching interactions:', error);
                    container.innerHTML = `
                <div class="p-4 bg-yellow-50 rounded-lg mb-3">
                    <p class="text-sm text-yellow-800">
                        Unable to load interaction data. Please try again later or consult with your healthcare provider.
                    </p>
                    <button onclick="fetchAndUpdateInteractions()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                        Try Again
                    </button>
                </div>
            `;
                });
        }
    </script>
{% endblock %}